#!/usr/bin/env node
/**
 * HTML to PowerPoint ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ä½¿ã„æ–¹:
 * 1. npm install (åˆå›ã®ã¿)
 * 2. node create-presentation.js
 * 3. node create-presentation.js part1 (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æŒ‡å®š)
 *
 * ç’°å¢ƒå¤‰æ•°:
 * - HTML2PPTX_PATH: html2pptxãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ã‚¹ (çœç•¥æ™‚ã¯ã‚¹ã‚­ãƒ«ã®assetsã‚’å‚ç…§)
 */

const pptxgen = require("pptxgenjs");
const fs = require("fs");
const path = require("path");
const { createResolver } = require("./utils/resolve");

// html2pptxã®ãƒ‘ã‚¹ã‚’è§£æ±º
const resolveHtml2pptx = createResolver(
  "HTML2PPTX_PATH",
  [path.join(process.cwd(), "html2pptx"), path.join(__dirname, "html2pptx")],
  "html2pptx not found. Set HTML2PPTX_PATH or copy html2pptx to project."
);

const html2pptxPath = resolveHtml2pptx();
const { html2pptx } = require(html2pptxPath);

async function buildPptx(filter, allSlideFiles, slidesDir) {
  const pptx = new pptxgen();
  pptx.layout = "LAYOUT_16x9";
  pptx.author = "Your Name";
  pptx.title = "Presentation";
  pptx.subject = "Generated by md2html2pptx";

  const slideFiles = filter
    ? allSlideFiles.filter(file => file.includes(filter))
    : allSlideFiles;

  const outputFile = filter
    ? `3_pptxs/${filter}.pptx`
    : "3_pptxs/presentation.pptx";

  console.log(`\nğŸ“¦ ${filter || "å…¨ã‚¹ãƒ©ã‚¤ãƒ‰"} (${slideFiles.length}æš) â†’ ${outputFile}`);

  for (let i = 0; i < slideFiles.length; i++) {
    const file = slideFiles[i];
    const slidePath = path.join(slidesDir, file);
    console.log(`  ğŸ“„ ${i + 1}: ${file}`);
    await html2pptx(slidePath, pptx);
  }

  await pptx.writeFile({ fileName: outputFile });
  console.log(`  âœ… ${outputFile} ä½œæˆå®Œäº†`);

  return { filter: filter || "all", file: outputFile, count: slideFiles.length };
}

async function createPresentation() {
  console.log("ğŸ¨ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­...");
  console.log(`   html2pptx: ${html2pptxPath}`);

  // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å–å¾—ï¼ˆè¤‡æ•°æŒ‡å®šå¯èƒ½ï¼‰
  const filterArgs = process.argv.slice(2);

  // 2_htmls/ ä»¥ä¸‹ã® HTML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆç‰¹æ®Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
  // é™¤å¤–: index.html, _preview.html, _ã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
  const slidesDir = "2_htmls";
  const allSlideFiles = fs.readdirSync(slidesDir)
    .filter(file => file.endsWith(".html") && !file.startsWith("_") && file !== "index.html")
    .sort();

  // 3_pptxsãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
  if (!fs.existsSync("3_pptxs")) {
    fs.mkdirSync("3_pptxs");
  }

  const results = [];

  if (filterArgs.length === 0) {
    const result = await buildPptx(null, allSlideFiles, slidesDir);
    results.push(result);
  } else if (filterArgs.length === 1) {
    const result = await buildPptx(filterArgs[0], allSlideFiles, slidesDir);
    results.push(result);
  } else {
    for (const filter of filterArgs) {
      const result = await buildPptx(filter, allSlideFiles, slidesDir);
      results.push(result);
    }
  }

  console.log("\nâœ¨ å®Œæˆã—ã¾ã—ãŸ!");
  console.log("ğŸ“Š ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:");
  for (const r of results) {
    console.log(`   - ${r.file} (${r.count}æš)`);
  }
}

createPresentation()
  .then(() => {
    console.log("\nğŸ‰ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
  })
  .catch((error) => {
    console.error("\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error.message);
    console.error("\nãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:");
    console.error("1. npm install ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„");
    console.error("2. npx playwright install chromium ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„");
    console.error("3. 2_htmls/ ãƒ•ã‚©ãƒ«ãƒ€ã«HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    process.exit(1);
  });
