/**
 * HTML to PowerPoint 変換 コアロジック
 *
 * CLI (to_pptx.js) およびテストから直接インポート可能。
 */

import fs from 'fs';
import path from 'path';
import { createRequire } from 'module';

const require = createRequire(import.meta.url);
const pptxgen = require('pptxgenjs');
const { lockShapesInPptx, detectLeanCanvasSlides } = require('./html2pptx/postprocess/lock-shapes.js');

/**
 * パス解決ユーティリティ
 */
function resolvePathFromCandidates(candidates) {
  return candidates.filter(Boolean).find(fs.existsSync) || null;
}

/**
 * html2pptx モジュールをロード
 * @param {string} [basePath] - 探索の基準ディレクトリ
 * @returns {{ html2pptx: Function, html2pptxPath: string }}
 */
export function loadHtml2pptx(basePath) {
  const assetsDir = basePath || path.dirname(new URL(import.meta.url).pathname);
  const html2pptxPath = resolvePathFromCandidates([
    process.env.HTML2PPTX_PATH,
    path.join(assetsDir, 'html2pptx'),
  ]);
  if (!html2pptxPath) {
    throw new Error('html2pptx not found. Set HTML2PPTX_PATH or place html2pptx in assets.');
  }
  const { html2pptx } = require(html2pptxPath);
  return { html2pptx, html2pptxPath };
}

/**
 * HTML ファイル群から PPTX を生成
 *
 * @param {Object} options
 * @param {string} options.slidesDir - HTML スライドが入ったディレクトリの絶対パス
 * @param {string} options.outputPath - 出力 PPTX ファイルの絶対パス
 * @param {string} [options.filter] - ファイル名フィルター
 * @param {string} [options.assetsDir] - assets ディレクトリ（省略時は自動解決）
 * @returns {Promise<{ file: string, count: number }>}
 */
export async function convertHtmlToPptx(options) {
  const {
    slidesDir,
    outputPath,
    filter,
    assetsDir: assetsDirOpt,
  } = options;

  const assetsDir = assetsDirOpt || path.dirname(new URL(import.meta.url).pathname);

  // html2pptx ロード
  const { html2pptx } = loadHtml2pptx(assetsDir);

  // HTML ファイルを取得
  const allSlideFiles = fs.readdirSync(slidesDir)
    .filter(file => file.endsWith('.html') && !file.startsWith('_') && file !== 'index.html')
    .sort();

  const slideFiles = filter
    ? allSlideFiles.filter(file => file.includes(filter))
    : allSlideFiles;

  // 出力ディレクトリ作成
  const outputDir = path.dirname(outputPath);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  // PPTX 生成
  const pptx = new pptxgen();
  pptx.layout = 'LAYOUT_16x9';
  pptx.author = 'Your Name';
  pptx.title = 'Presentation';
  pptx.subject = 'Generated by md2html2pptx';

  for (const file of slideFiles) {
    const slidePath = path.join(slidesDir, file);
    await html2pptx(slidePath, pptx);
  }

  await pptx.writeFile({ fileName: outputPath });

  return { file: outputPath, count: slideFiles.length };
}
